[gd_scene load_steps=5 format=3 uid="uid://b7totafptfwco"]

[sub_resource type="GDScript" id="GDScript_pa3k5"]
script/source = "
extends StaticBody3D
@onready var viewport : SubViewport = %SubViewport
@onready var mesh : MeshInstance3D = $panel
@onready var colShape : CollisionShape3D = $CollisionShape3D
@onready var label_3d = $Label3D
var hoverevent : InputEventMouseMotion
var clickevent : InputEventMouseButton
var hovered : bool = false
var clicked : bool = false

func _ready():
	colShape.position.y = -colShape.shape.size.y/2.0

func _process(delta):
	mesh.mesh.material.albedo_texture = viewport.get_texture()
	colShape.shape.size = Vector3(mesh.mesh.size.x,.01,mesh.mesh.size.y)

func _physics_process(delta):
	if clicked:
		viewport.push_input(clickevent,true)
		print('clickevent')
		clickevent = InputEventMouseButton.new()
		clicked = false
	elif hovered:
		viewport.push_input(hoverevent,true)
		hovered = false

func laserClick(data:Dictionary):
	clickevent = InputEventMouseButton.new()
	clickevent.pressed = data.pressed
	clickevent.button_index = 1
#	clickevent.button_mask = 1
	# Get mesh size to detect edges and make conversions. This code only support PlaneMesh and QuadMesh.
	var quad_mesh_size = mesh.mesh.size
	var mouse_pos3D = to_local(data.position)
	# convert the relative event position from 3D to 2D
	var mouse_pos2D = Vector2(mouse_pos3D.x, mouse_pos3D.z)
	# Right now the event position's range is the following: (-quad_size/2) -> (quad_size/2)
	# We need to convert it into the following range: 0 -> quad_size
	mouse_pos2D.x += quad_mesh_size.x / 2
	mouse_pos2D.y += quad_mesh_size.y / 2
	# Then we need to convert it into the following range: 0 -> 1
	mouse_pos2D.x = mouse_pos2D.x / quad_mesh_size.x
	mouse_pos2D.y = mouse_pos2D.y / quad_mesh_size.y
	# Finally, we convert the position to the following range: 0 -> viewport.size
	mouse_pos2D.x = mouse_pos2D.x * viewport.size.x
	mouse_pos2D.y = mouse_pos2D.y * viewport.size.y
	# We need to do these conversions so the event's position is in the viewport's coordinate system.
	# Set the event's position and global position.
	clickevent.position = mouse_pos2D
	clickevent.global_position = mouse_pos2D
	clicked = true

func laserHover(data:Dictionary):
	if !hovered and !clicked and data.has(\"position\"):
		# We need to fabricate a fake mouse input even for translating a raycast click to a simulated mouse click on the viewport.
		hoverevent = InputEventMouseMotion.new()
	#	event.pressed = data.pressed
	#	event.button_index = 1
	#	event.button_mask = 1
		var quad_mesh_size = mesh.mesh.size
		var mouse_pos3D = to_local(data.position)
		var mouse_pos2D = Vector2(mouse_pos3D.x, mouse_pos3D.z)
		mouse_pos2D.x += quad_mesh_size.x / 2
		mouse_pos2D.y += quad_mesh_size.y / 2
		mouse_pos2D.x = mouse_pos2D.x / quad_mesh_size.x
		mouse_pos2D.y = mouse_pos2D.y / quad_mesh_size.y
		mouse_pos2D.x = mouse_pos2D.x * viewport.size.x
		mouse_pos2D.y = mouse_pos2D.y * viewport.size.y
		hoverevent.position = mouse_pos2D
		hoverevent.global_position = mouse_pos2D
		hovered = true

#func _input(event):
#	print(event)
#	viewport.push_input(event)

func set_ui(node:Control):
	viewport.add_child(node)
#	node.gui_input.connect(func(event):
#		label_3d.text = str(event)
#		)
"

[sub_resource type="BoxShape3D" id="BoxShape3D_j0pg5"]
size = Vector3(1, 0.01, 1)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_4ksv4"]
resource_local_to_scene = true
transparency = 2
alpha_scissor_threshold = 0.5
alpha_antialiasing_mode = 0
cull_mode = 2
shading_mode = 0

[sub_resource type="PlaneMesh" id="PlaneMesh_r1rr1"]
resource_local_to_scene = true
material = SubResource("StandardMaterial3D_4ksv4")
size = Vector2(0.5, 0.5)

[node name="StaticBody3D" type="StaticBody3D"]
transform = Transform3D(1, 0, 0, 0, 0, -1, 0, 1, 0, 0, 0, 0)
collision_layer = 4
collision_mask = 0
script = SubResource("GDScript_pa3k5")
metadata/grabbable = true

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
shape = SubResource("BoxShape3D_j0pg5")

[node name="panel" type="MeshInstance3D" parent="."]
mesh = SubResource("PlaneMesh_r1rr1")
skeleton = NodePath("../..")

[node name="Label3D" type="Label3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.1, 0)

[node name="SubViewport" type="SubViewport" parent="."]
unique_name_in_owner = true
disable_3d = true
transparent_bg = true
size = Vector2i(1024, 1024)
render_target_update_mode = 4

[node name="Button" type="Button" parent="SubViewport"]
offset_right = 71.0
offset_bottom = 31.0
text = "click me"
